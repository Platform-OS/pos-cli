import{S as $e,i as Te,s as we,k as _,a as N,y as _e,q as P,l as m,m as h,c as j,z as me,r as B,h as i,n as u,b as X,E as r,A as he,H as te,g as z,d as W,B as pe,V as Ge,w as Ie,Q as Ze,W as Ke,L as xe,X as Ce,Y as Me,f as Qe,Z as We,u as ve,R as et,T as tt,U as at,_ as st,I as Xe,F as lt,$ as rt,G as qe,v as Ye,a0 as He,a1 as nt}from"../chunks/index.d0f8a730.js";import"../chunks/singletons.c0ca4dec.js";import{p as ot}from"../chunks/stores.c3239767.js";import{b as Se}from"../chunks/backgroundJob.d6a5759b.js";import{I as Ae}from"../chunks/Icon.1de0c66c.js";import{s as Ee}from"../chunks/state.c2a70a8a.js";const fe=e=>{const a=e instanceof Date?e:new Date(e),t=new Intl.RelativeTimeFormat("en"),s={years:3600*24*365,months:3600*24*30,weeks:3600*24*7,days:3600*24,hours:3600,minutes:60,seconds:1},l=(a.getTime()-Date.now())/1e3;for(let n in s)if(s[n]<Math.abs(l)){const d=l/s[n];return t.format(Math.round(d),n)}};function it(e){let a,t,s,l,n,d,p,o,E;return n=new Ae({props:{icon:"refresh",size:"22"}}),{c(){a=_("form"),t=_("input"),s=N(),l=_("button"),_e(n.$$.fragment),d=P(`\r
    Retry`),this.h()},l(c){a=m(c,"FORM",{});var f=h(a);t=m(f,"INPUT",{type:!0,name:!0}),s=j(f),l=m(f,"BUTTON",{class:!0});var $=h(l);me(n.$$.fragment,$),d=B($,`\r
    Retry`),$.forEach(i),f.forEach(i),this.h()},h(){u(t,"type","hidden"),u(t,"name","id"),t.value=e[0],u(l,"class","danger")},m(c,f){X(c,a,f),r(a,t),r(a,s),r(a,l),he(n,l,null),r(l,d),e[3](a),p=!0,o||(E=te(a,"submit",e[2]),o=!0)},p(c,[f]){(!p||f&1)&&(t.value=c[0])},i(c){p||(z(n.$$.fragment,c),p=!0)},o(c){W(n.$$.fragment,c),p=!1},d(c){c&&i(a),pe(n),e[3](null),o=!1,E()}}}function ut(e,a,t){let{id:s}=a,l;const n=Ge(),d=async o=>{o.preventDefault();const E=await Se.retry({properties:new FormData(l)});E.errors?Ee.notification.create("error",`Background job ${E.admin_background_job_retry.id} could not be run again`):(n("itemsChanged"),Ee.notification.create("success",`Background job ${E.admin_background_job_retry.id} planned to run again`))};function p(o){Ie[o?"unshift":"push"](()=>{l=o,t(1,l)})}return e.$$set=o=>{"id"in o&&t(0,s=o.id)},[s,l,d,p]}class ct extends $e{constructor(a){super(),Te(this,a,ut,it,we,{id:0})}}function ft(e){let a,t,s,l,n,d,p,o,E,c;return d=new Ae({props:{icon:"x",size:"22"}}),{c(){a=_("form"),t=_("input"),s=N(),l=_("button"),n=_("i"),_e(d.$$.fragment),p=P(`\r
    Delete background job`),this.h()},l(f){a=m(f,"FORM",{});var $=h(a);t=m($,"INPUT",{type:!0,name:!0}),s=j($),l=m($,"BUTTON",{class:!0});var T=h(l);n=m(T,"I",{class:!0});var A=h(n);me(d.$$.fragment,A),A.forEach(i),p=B(T,`\r
    Delete background job`),T.forEach(i),$.forEach(i),this.h()},h(){u(t,"type","hidden"),u(t,"name","id"),t.value=e[0],u(n,"class","svelte-ooaugn"),u(l,"class","danger")},m(f,$){X(f,a,$),r(a,t),r(a,s),r(a,l),r(l,n),he(d,n,null),r(l,p),e[3](a),o=!0,E||(c=te(a,"submit",e[2]),E=!0)},p(f,[$]){(!o||$&1)&&(t.value=f[0])},i(f){o||(z(d.$$.fragment,f),o=!0)},o(f){W(d.$$.fragment,f),o=!1},d(f){f&&i(a),pe(d),e[3](null),E=!1,c()}}}function dt(e,a,t){let{id:s}=a,l;const n=Ge(),d=async o=>{if(o.preventDefault(),confirm("Are you sure you want to delete this background job?")){const E=await Se.delete({properties:new FormData(l)});E.errors?Ee.notification.create("error",`Background job ${E.admin_background_job_delete.id} could not be deleted`):(n("itemsChanged"),Ee.notification.create("success",`Background job ${E.admin_background_job_delete.id} deleted`))}};function p(o){Ie[o?"unshift":"push"](()=>{l=o,t(1,l)})}return e.$$set=o=>{"id"in o&&t(0,s=o.id)},[s,l,d,p]}class _t extends $e{constructor(a){super(),Te(this,a,dt,ft,we,{id:0})}}function Ve(e,a,t){const s=e.slice();return s[15]=a[t],s}function mt(e){let a;return{c(){a=P("Runs")},l(t){a=B(t,"Runs")},m(t,s){X(t,a,s)},d(t){t&&i(a)}}}function ht(e){let a;return{c(){a=P("Failed")},l(t){a=B(t,"Failed")},m(t,s){X(t,a,s)},d(t){t&&i(a)}}}function ze(e){let a,t,s;return t=new ct({props:{id:e[15].id}}),t.$on("itemsChanged",e[5]),{c(){a=_("li"),_e(t.$$.fragment),this.h()},l(l){a=m(l,"LI",{class:!0});var n=h(a);me(t.$$.fragment,n),n.forEach(i),this.h()},h(){u(a,"class","svelte-hyom4y")},m(l,n){X(l,a,n),he(t,a,null),s=!0},p(l,n){const d={};n&2&&(d.id=l[15].id),t.$set(d)},i(l){s||(z(t.$$.fragment,l),s=!0)},o(l){W(t.$$.fragment,l),s=!1},d(l){l&&i(a),pe(t)}}}function pt(e){let a=(e[15].run_at_parsed||fe(new Date(e[15].run_at)))+"",t;return{c(){t=P(a)},l(s){t=B(s,a)},m(s,l){X(s,t,l)},p(s,l){l&2&&a!==(a=(s[15].run_at_parsed||fe(new Date(s[15].run_at)))+"")&&ve(t,a)},d(s){s&&i(t)}}}function vt(e){let a=(e[15].dead_at_parsed||fe(new Date(e[15].dead_at))||"")+"",t;return{c(){t=P(a)},l(s){t=B(s,a)},m(s,l){X(s,t,l)},p(s,l){l&2&&a!==(a=(s[15].dead_at_parsed||fe(new Date(s[15].dead_at))||"")+"")&&ve(t,a)},d(s){s&&i(t)}}}function Je(e){let a,t,s,l,n,d,p,o,E,c,f,$,T,A,Y,I,y=(e[15].source_name||e[15].id)+"",U,J,ae,G,M=e[15].queue+"",ee,se,R,le,q,C,oe;o=new Ae({props:{icon:"navigationMenuVertical",size:"16"}});function L(){return e[10](e[15])}let D=e[15].dead_at&&ze(e);A=new _t({props:{id:e[15].id}}),A.$on("itemsChanged",e[5]);function ie(S,g){return S[0].type==="DEAD"?vt:pt}let Q=ie(e),F=Q(e);return{c(){a=_("tr"),t=_("td"),s=_("div"),l=_("button"),n=_("span"),d=P("More options"),p=N(),_e(o.$$.fragment),E=N(),c=_("menu"),f=_("ul"),D&&D.c(),$=N(),T=_("li"),_e(A.$$.fragment),Y=N(),I=_("a"),U=P(y),ae=N(),G=_("td"),ee=P(M),se=N(),R=_("td"),F.c(),le=N(),this.h()},l(S){a=m(S,"TR",{class:!0});var g=h(a);t=m(g,"TD",{class:!0});var Z=h(t);s=m(Z,"DIV",{class:!0});var K=h(s);l=m(K,"BUTTON",{class:!0});var re=h(l);n=m(re,"SPAN",{class:!0});var ne=h(n);d=B(ne,"More options"),ne.forEach(i),p=j(re),me(o.$$.fragment,re),re.forEach(i),E=j(K),c=m(K,"MENU",{class:!0});var H=h(c);f=m(H,"UL",{});var V=h(f);D&&D.l(V),$=j(V),T=m(V,"LI",{class:!0});var b=h(T);me(A.$$.fragment,b),b.forEach(i),V.forEach(i),H.forEach(i),Y=j(K),I=m(K,"A",{href:!0,class:!0});var ge=h(I);U=B(ge,y),ge.forEach(i),K.forEach(i),Z.forEach(i),ae=j(g),G=m(g,"TD",{class:!0});var ue=h(G);ee=B(ue,M),ue.forEach(i),se=j(g),R=m(g,"TD",{class:!0});var O=h(R);F.l(O),O.forEach(i),le=j(g),g.forEach(i),this.h()},h(){u(n,"class","label"),u(l,"class","button compact more svelte-hyom4y"),u(T,"class","svelte-hyom4y"),u(c,"class","content-context svelte-hyom4y"),qe(c,"active",e[2].id===e[15].id),u(I,"href",J="/backgroundJobs/"+e[0].type.toLowerCase()+"/"+e[15].id+"?"+e[4].url.searchParams.toString()),u(I,"class","svelte-hyom4y"),u(s,"class","svelte-hyom4y"),u(t,"class","id svelte-hyom4y"),u(G,"class","svelte-hyom4y"),u(R,"class","svelte-hyom4y"),u(a,"class","svelte-hyom4y")},m(S,g){X(S,a,g),r(a,t),r(t,s),r(s,l),r(l,n),r(n,d),r(l,p),he(o,l,null),r(s,E),r(s,c),r(c,f),D&&D.m(f,null),r(f,$),r(f,T),he(A,T,null),r(s,Y),r(s,I),r(I,U),r(a,ae),r(a,G),r(G,ee),r(a,se),r(a,R),F.m(R,null),r(a,le),q=!0,C||(oe=[te(l,"click",L),te(t,"mouseleave",e[11])],C=!0)},p(S,g){e=S,e[15].dead_at?D?(D.p(e,g),g&2&&z(D,1)):(D=ze(e),D.c(),z(D,1),D.m(f,$)):D&&(Ye(),W(D,1,1,()=>{D=null}),Qe());const Z={};g&2&&(Z.id=e[15].id),A.$set(Z),(!q||g&6)&&qe(c,"active",e[2].id===e[15].id),(!q||g&2)&&y!==(y=(e[15].source_name||e[15].id)+"")&&ve(U,y),(!q||g&19&&J!==(J="/backgroundJobs/"+e[0].type.toLowerCase()+"/"+e[15].id+"?"+e[4].url.searchParams.toString()))&&u(I,"href",J),(!q||g&2)&&M!==(M=e[15].queue+"")&&ve(ee,M),Q===(Q=ie(e))&&F?F.p(e,g):(F.d(1),F=Q(e),F&&(F.c(),F.m(R,null)))},i(S){q||(z(o.$$.fragment,S),z(D),z(A.$$.fragment,S),q=!0)},o(S){W(o.$$.fragment,S),W(D),W(A.$$.fragment,S),q=!1},d(S){S&&i(a),pe(o),D&&D.d(),pe(A),F.d(),C=!1,Xe(oe)}}}function gt(e){let a,t,s,l,n,d,p,o,E,c,f,$,T,A,Y,I,y,U,J,ae,G,M,ee,se,R,le,q,C,oe,L,D,ie,Q=(e[1].total_pages||"")+"",F,S,g,Z,K;function re(v,w){return v[0].type==="DEAD"?ht:mt}let ne=re(e),H=ne(e),V=e[1].results,b=[];for(let v=0;v<V.length;v+=1)b[v]=Je(Ve(e,V,v));const ge=v=>W(b[v],1,1,()=>{b[v]=null}),ue=e[7].default,O=Ze(ue,e,e[6],null);return{c(){a=N(),t=_("div"),s=_("div"),l=_("nav"),n=_("form"),d=_("fieldset"),p=_("label"),o=P("Type:"),E=N(),c=_("select"),f=_("option"),$=P("Scheduled"),T=_("option"),A=P("Failed"),Y=N(),I=_("table"),y=_("thead"),U=_("tr"),J=_("th"),ae=P("Name / id"),G=N(),M=_("th"),ee=P("Priority"),se=N(),R=_("th"),H.c(),le=N();for(let v=0;v<b.length;v+=1)b[v].c();q=N(),C=_("nav"),oe=P(`Page:\r
      `),L=_("input"),ie=P(`\r
      of `),F=P(Q),S=N(),O&&O.c(),this.h()},l(v){Ke("svelte-16df4tm",document.head).forEach(i),a=j(v),t=m(v,"DIV",{class:!0});var k=h(t);s=m(k,"DIV",{class:!0});var x=h(s);l=m(x,"NAV",{class:!0});var Le=h(l);n=m(Le,"FORM",{id:!0,class:!0});var Ne=h(n);d=m(Ne,"FIELDSET",{class:!0});var ye=h(d);p=m(ye,"LABEL",{for:!0});var Pe=h(p);o=B(Pe,"Type:"),Pe.forEach(i),E=j(ye),c=m(ye,"SELECT",{name:!0,id:!0});var De=h(c);f=m(De,"OPTION",{});var je=h(f);$=B(je,"Scheduled"),je.forEach(i),T=m(De,"OPTION",{});var Be=h(T);A=B(Be,"Failed"),Be.forEach(i),De.forEach(i),ye.forEach(i),Ne.forEach(i),Le.forEach(i),Y=j(x),I=m(x,"TABLE",{class:!0});var be=h(I);y=m(be,"THEAD",{class:!0});var Fe=h(y);U=m(Fe,"TR",{});var ce=h(U);J=m(ce,"TH",{class:!0});var Oe=h(J);ae=B(Oe,"Name / id"),Oe.forEach(i),G=j(ce),M=m(ce,"TH",{class:!0});var Re=h(M);ee=B(Re,"Priority"),Re.forEach(i),se=j(ce),R=m(ce,"TH",{class:!0});var Ue=h(R);H.l(Ue),Ue.forEach(i),ce.forEach(i),Fe.forEach(i),le=j(be);for(let ke=0;ke<b.length;ke+=1)b[ke].l(be);be.forEach(i),q=j(x),C=m(x,"NAV",{class:!0});var de=h(C);oe=B(de,`Page:\r
      `),L=m(de,"INPUT",{type:!0,name:!0,min:!0,max:!0,step:!0,form:!0}),ie=B(de,`\r
      of `),F=B(de,Q),de.forEach(i),x.forEach(i),S=j(k),O&&O.l(k),k.forEach(i),this.h()},h(){document.title="Background Jobs | platformOS",u(p,"for","filter-type"),f.__value="SCHEDULED",f.value=f.__value,T.__value="DEAD",T.value=T.__value,u(c,"name","type"),u(c,"id","filter-type"),e[0].type===void 0&&xe(()=>e[8].call(c)),u(d,"class","svelte-hyom4y"),u(n,"id","filters"),u(n,"class","svelte-hyom4y"),u(l,"class","filters svelte-hyom4y"),u(J,"class","id svelte-hyom4y"),u(M,"class","svelte-hyom4y"),u(R,"class","svelte-hyom4y"),u(y,"class","svelte-hyom4y"),u(I,"class","svelte-hyom4y"),u(L,"type","number"),u(L,"name","page"),u(L,"min","1"),u(L,"max",D=e[1].total_pages||100),u(L,"step","1"),u(L,"form","filters"),u(C,"class","pagination svelte-hyom4y"),u(s,"class","svelte-hyom4y"),u(t,"class","container svelte-hyom4y")},m(v,w){X(v,a,w),X(v,t,w),r(t,s),r(s,l),r(l,n),r(n,d),r(d,p),r(p,o),r(d,E),r(d,c),r(c,f),r(f,$),r(c,T),r(T,A),Ce(c,e[0].type,!0),e[9](n),r(s,Y),r(s,I),r(I,y),r(y,U),r(U,J),r(J,ae),r(U,G),r(U,M),r(M,ee),r(U,se),r(U,R),H.m(R,null),r(I,le);for(let k=0;k<b.length;k+=1)b[k]&&b[k].m(I,null);r(s,q),r(s,C),r(C,oe),r(C,L),Me(L,e[0].page),r(C,ie),r(C,F),r(t,S),O&&O.m(t,null),g=!0,Z||(K=[te(c,"change",e[8]),te(c,"change",function(){He(e[3].requestSubmit())&&e[3].requestSubmit().apply(this,arguments)}),te(L,"input",e[12]),te(L,"change",function(){He(e[3].requestSubmit())&&e[3].requestSubmit().apply(this,arguments)})],Z=!0)},p(v,[w]){if(e=v,w&1&&Ce(c,e[0].type),ne!==(ne=re(e))&&(H.d(1),H=ne(e),H&&(H.c(),H.m(R,null))),w&55){V=e[1].results;let k;for(k=0;k<V.length;k+=1){const x=Ve(e,V,k);b[k]?(b[k].p(x,w),z(b[k],1)):(b[k]=Je(x),b[k].c(),z(b[k],1),b[k].m(I,null))}for(Ye(),k=V.length;k<b.length;k+=1)ge(k);Qe()}(!g||w&2&&D!==(D=e[1].total_pages||100))&&u(L,"max",D),w&1&&We(L.value)!==e[0].page&&Me(L,e[0].page),(!g||w&2)&&Q!==(Q=(e[1].total_pages||"")+"")&&ve(F,Q),O&&O.p&&(!g||w&64)&&et(O,ue,e,e[6],g?at(ue,e[6],w,null):tt(e[6]),null)},i(v){if(!g){for(let w=0;w<V.length;w+=1)z(b[w]);z(O,v),g=!0}},o(v){b=b.filter(Boolean);for(let w=0;w<b.length;w+=1)W(b[w]);W(O,v),g=!1},d(v){v&&i(a),v&&i(t),e[9](null),H.d(),st(b,v),O&&O.d(v),Z=!1,Xe(K)}}}function yt(e,a,t){let s;lt(e,ot,y=>t(4,s=y));let{$$slots:l={},$$scope:n}=a,d={results:[]},p={id:null},o={page:1,type:"SCHEDULED",...Object.fromEntries(s.url.searchParams)},E,c;const f=async()=>{clearInterval(c),t(1,d=await Se.get(o)),c=setInterval(()=>{d.results.forEach(y=>{o.type==="DEAD"?y.dead_at_parsed=fe(new Date(y.dead_at)):y.run_at_parsed=fe(new Date(y.run_at))})},1e3)};rt(()=>{clearInterval(c)});function $(){o.type=nt(this),t(0,o)}function T(y){Ie[y?"unshift":"push"](()=>{E=y,t(3,E)})}const A=y=>t(2,p.id=y.id,p),Y=()=>t(2,p.id=null,p);function I(){o.page=We(this.value),t(0,o)}return e.$$set=y=>{"$$scope"in y&&t(6,n=y.$$scope)},e.$$.update=()=>{e.$$.dirty&1&&o&&f()},[o,d,p,E,s,f,n,l,$,T,A,Y,I]}class wt extends $e{constructor(a){super(),Te(this,a,yt,gt,we,{})}}export{wt as component};
