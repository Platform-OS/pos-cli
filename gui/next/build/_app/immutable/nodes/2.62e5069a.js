import{s as Ie,f as c,a as L,l as W,g as _,h as b,c as N,m as X,d,j as m,i as Y,u as l,x as fe,H as ze,p as ke,I as Fe,D as Ye,J as Ze,r as oe,K as Re,B as xe,L as Me,M as et,n as be,E as tt,F as at,G as nt,N as st,y as Ge,v as lt,O as rt,w as Ue,P as ot}from"../chunks/scheduler.897e742f.js";import{S as Le,i as Ne,b as ce,d as _e,m as me,a as q,t as z,e as he,h as it,c as Ke,g as Qe}from"../chunks/index.dbb1a760.js";import{e as qe}from"../chunks/each.7879f7b3.js";import"../chunks/singletons.ea25e0c6.js";import{p as ut}from"../chunks/stores.f7a067c7.js";import{b as Se}from"../chunks/backgroundJob.a61b4e2d.js";import{I as Ae}from"../chunks/Icon.db5b5802.js";import{N as dt}from"../chunks/Number.06b56bb1.js";import{s as De}from"../chunks/state.67fbed0a.js";const pe=e=>{const a=e instanceof Date?e:new Date(e),t=new Intl.RelativeTimeFormat("en"),n={years:3600*24*365,months:3600*24*30,weeks:3600*24*7,days:3600*24,hours:3600,minutes:60,seconds:1},s=(a.getTime()-Date.now())/1e3;for(let r in n)if(n[r]<Math.abs(s)){const f=s/n[r];return t.format(Math.round(f),r)}};function ft(e){let a,t,n,s,r,f,p,o,y;return r=new Ae({props:{icon:"refresh",size:"22"}}),{c(){a=c("form"),t=c("input"),n=L(),s=c("button"),ce(r.$$.fragment),f=W(`\r
    Retry`),this.h()},l(u){a=_(u,"FORM",{});var i=b(a);t=_(i,"INPUT",{type:!0,name:!0}),n=N(i),s=_(i,"BUTTON",{class:!0});var D=b(s);_e(r.$$.fragment,D),f=X(D,`\r
    Retry`),D.forEach(d),i.forEach(d),this.h()},h(){m(t,"type","hidden"),m(t,"name","id"),t.value=e[0],m(s,"class","danger")},m(u,i){Y(u,a,i),l(a,t),l(a,n),l(a,s),me(r,s,null),l(s,f),e[3](a),p=!0,o||(y=fe(a,"submit",e[2]),o=!0)},p(u,[i]){(!p||i&1)&&(t.value=u[0])},i(u){p||(q(r.$$.fragment,u),p=!0)},o(u){z(r.$$.fragment,u),p=!1},d(u){u&&d(a),he(r),e[3](null),o=!1,y()}}}function ct(e,a,t){let{id:n}=a,s;const r=ze(),f=async o=>{o.preventDefault();const y=await Se.retry({properties:new FormData(s)});y.errors?De.notification.create("error",`Background job ${y.admin_background_job_retry.id} could not be run again`):(r("itemsChanged"),De.notification.create("success",`Background job ${y.admin_background_job_retry.id} planned to run again`))};function p(o){ke[o?"unshift":"push"](()=>{s=o,t(1,s)})}return e.$$set=o=>{"id"in o&&t(0,n=o.id)},[n,s,f,p]}class _t extends Le{constructor(a){super(),Ne(this,a,ct,ft,Ie,{id:0})}}function mt(e){let a,t,n,s,r,f,p,o,y,u;return f=new Ae({props:{icon:"x",size:"22"}}),{c(){a=c("form"),t=c("input"),n=L(),s=c("button"),r=c("i"),ce(f.$$.fragment),p=W(`\r
    Delete background job`),this.h()},l(i){a=_(i,"FORM",{});var D=b(a);t=_(D,"INPUT",{type:!0,name:!0}),n=N(D),s=_(D,"BUTTON",{class:!0});var k=b(s);r=_(k,"I",{class:!0});var S=b(r);_e(f.$$.fragment,S),S.forEach(d),p=X(k,`\r
    Delete background job`),k.forEach(d),D.forEach(d),this.h()},h(){m(t,"type","hidden"),m(t,"name","id"),t.value=e[0],m(r,"class","svelte-ooaugn"),m(s,"class","danger")},m(i,D){Y(i,a,D),l(a,t),l(a,n),l(a,s),l(s,r),me(f,r,null),l(s,p),e[3](a),o=!0,y||(u=fe(a,"submit",e[2]),y=!0)},p(i,[D]){(!o||D&1)&&(t.value=i[0])},i(i){o||(q(f.$$.fragment,i),o=!0)},o(i){z(f.$$.fragment,i),o=!1},d(i){i&&d(a),he(f),e[3](null),y=!1,u()}}}function ht(e,a,t){let{id:n}=a,s;const r=ze(),f=async o=>{if(o.preventDefault(),confirm("Are you sure you want to delete this background job?")){const y=await Se.delete({properties:new FormData(s)});y.errors?De.notification.create("error",`Background job ${y.admin_background_job_delete.id} could not be deleted`):(r("itemsChanged"),De.notification.create("success",`Background job ${y.admin_background_job_delete.id} deleted`))}};function p(o){ke[o?"unshift":"push"](()=>{s=o,t(1,s)})}return e.$$set=o=>{"id"in o&&t(0,n=o.id)},[n,s,f,p]}class pt extends Le{constructor(a){super(),Ne(this,a,ht,mt,Ie,{id:0})}}function He(e,a,t){const n=e.slice();return n[15]=a[t],n}function gt(e){let a;return{c(){a=W("Runs")},l(t){a=X(t,"Runs")},m(t,n){Y(t,a,n)},d(t){t&&d(a)}}}function vt(e){let a;return{c(){a=W("Failed")},l(t){a=X(t,"Failed")},m(t,n){Y(t,a,n)},d(t){t&&d(a)}}}function Ve(e){let a,t,n;return t=new _t({props:{id:e[15].id}}),t.$on("itemsChanged",e[5]),{c(){a=c("li"),ce(t.$$.fragment),this.h()},l(s){a=_(s,"LI",{class:!0});var r=b(a);_e(t.$$.fragment,r),r.forEach(d),this.h()},h(){m(a,"class","svelte-1m1ug4d")},m(s,r){Y(s,a,r),me(t,a,null),n=!0},p(s,r){const f={};r&2&&(f.id=s[15].id),t.$set(f)},i(s){n||(q(t.$$.fragment,s),n=!0)},o(s){z(t.$$.fragment,s),n=!1},d(s){s&&d(a),he(t)}}}function bt(e){let a=(e[15].run_at_parsed||pe(new Date(e[15].run_at)))+"",t;return{c(){t=W(a)},l(n){t=X(n,a)},m(n,s){Y(n,t,s)},p(n,s){s&2&&a!==(a=(n[15].run_at_parsed||pe(new Date(n[15].run_at)))+"")&&be(t,a)},d(n){n&&d(t)}}}function yt(e){let a=(e[15].dead_at_parsed||pe(new Date(e[15].dead_at))||"")+"",t;return{c(){t=W(a)},l(n){t=X(n,a)},m(n,s){Y(n,t,s)},p(n,s){s&2&&a!==(a=(n[15].dead_at_parsed||pe(new Date(n[15].dead_at))||"")+"")&&be(t,a)},d(n){n&&d(t)}}}function Je(e){let a,t,n,s,r,f="More options",p,o,y,u,i,D,k,S,Z,I,g=(e[15].source_name||e[15].id)+"",B,H,ie,G,F=e[15].queue+"",ae,ne,A,se,V,O,K;o=new Ae({props:{icon:"navigationMenuVertical",size:"16"}});function ye(){return e[10](e[15])}let E=e[15].dead_at&&Ve(e);S=new pt({props:{id:e[15].id}}),S.$on("itemsChanged",e[5]);function R(w,$){return w[0].type==="DEAD"?yt:bt}let ee=R(e),j=ee(e);return{c(){a=c("tr"),t=c("td"),n=c("div"),s=c("button"),r=c("span"),r.textContent=f,p=L(),ce(o.$$.fragment),y=L(),u=c("menu"),i=c("ul"),E&&E.c(),D=L(),k=c("li"),ce(S.$$.fragment),Z=L(),I=c("a"),B=W(g),ie=L(),G=c("td"),ae=W(F),ne=L(),A=c("td"),j.c(),se=L(),this.h()},l(w){a=_(w,"TR",{class:!0});var $=b(a);t=_($,"TD",{class:!0});var x=b(t);n=_(x,"DIV",{class:!0});var P=b(n);s=_(P,"BUTTON",{class:!0});var te=b(s);r=_(te,"SPAN",{class:!0,"data-svelte-h":!0}),oe(r)!=="svelte-1agpmtc"&&(r.textContent=f),p=N(te),_e(o.$$.fragment,te),te.forEach(d),y=N(P),u=_(P,"MENU",{class:!0});var ge=b(u);i=_(ge,"UL",{});var le=b(i);E&&E.l(le),D=N(le),k=_(le,"LI",{class:!0});var re=b(k);_e(S.$$.fragment,re),re.forEach(d),le.forEach(d),ge.forEach(d),Z=N(P),I=_(P,"A",{href:!0,class:!0});var J=b(I);B=X(J,g),J.forEach(d),P.forEach(d),x.forEach(d),ie=N($),G=_($,"TD",{class:!0});var Q=b(G);ae=X(Q,F),Q.forEach(d),ne=N($),A=_($,"TD",{class:!0});var v=b(A);j.l(v),v.forEach(d),se=N($),$.forEach(d),this.h()},h(){m(r,"class","label"),m(s,"class","button compact more svelte-1m1ug4d"),m(k,"class","svelte-1m1ug4d"),m(u,"class","content-context svelte-1m1ug4d"),Ue(u,"active",e[2].id===e[15].id),m(I,"href",H="/backgroundJobs/"+e[0].type.toLowerCase()+"/"+e[15].id+"?"+e[4].url.searchParams.toString()),m(I,"class","svelte-1m1ug4d"),m(n,"class","svelte-1m1ug4d"),m(t,"class","id svelte-1m1ug4d"),m(G,"class","svelte-1m1ug4d"),m(A,"class","svelte-1m1ug4d"),m(a,"class","svelte-1m1ug4d")},m(w,$){Y(w,a,$),l(a,t),l(t,n),l(n,s),l(s,r),l(s,p),me(o,s,null),l(n,y),l(n,u),l(u,i),E&&E.m(i,null),l(i,D),l(i,k),me(S,k,null),l(n,Z),l(n,I),l(I,B),l(a,ie),l(a,G),l(G,ae),l(a,ne),l(a,A),j.m(A,null),l(a,se),V=!0,O||(K=[fe(s,"click",ye),fe(t,"mouseleave",e[11])],O=!0)},p(w,$){e=w,e[15].dead_at?E?(E.p(e,$),$&2&&q(E,1)):(E=Ve(e),E.c(),q(E,1),E.m(i,D)):E&&(Qe(),z(E,1,1,()=>{E=null}),Ke());const x={};$&2&&(x.id=e[15].id),S.$set(x),(!V||$&6)&&Ue(u,"active",e[2].id===e[15].id),(!V||$&2)&&g!==(g=(e[15].source_name||e[15].id)+"")&&be(B,g),(!V||$&19&&H!==(H="/backgroundJobs/"+e[0].type.toLowerCase()+"/"+e[15].id+"?"+e[4].url.searchParams.toString()))&&m(I,"href",H),(!V||$&2)&&F!==(F=e[15].queue+"")&&be(ae,F),ee===(ee=R(e))&&j?j.p(e,$):(j.d(1),j=ee(e),j&&(j.c(),j.m(A,null)))},i(w){V||(q(o.$$.fragment,w),q(E),q(S.$$.fragment,w),V=!0)},o(w){z(o.$$.fragment,w),z(E),z(S.$$.fragment,w),V=!1},d(w){w&&d(a),he(o),E&&E.d(),he(S),j.d(),O=!1,Ge(K)}}}function Et(e){let a,t,n,s,r,f,p,o="Type:",y,u,i,D="Scheduled",k,S="Failed",Z,I,g,B,H,ie="Name / id",G,F,ae="Priority",ne,A,se,V,O,K,ye="Page:",E,R,ee,j,w=(e[1].total_pages||1)+"",$,x,P,te,ge;function le(h,T){return h[0].type==="DEAD"?vt:gt}let re=le(e),J=re(e),Q=qe(e[1].results),v=[];for(let h=0;h<Q.length;h+=1)v[h]=Je(He(e,Q,h));const We=h=>z(v[h],1,1,()=>{v[h]=null});function Xe(h){e[12](h)}let je={form:"filters",name:"page",min:1,max:e[1].total_pages,step:1,decreaseLabel:"Previous page",increaseLabel:"Next page",style:"navigation"};e[0].page!==void 0&&(je.value=e[0].page),R=new dt({props:je}),ke.push(()=>it(R,"value",Xe)),R.$on("input",function(){Fe(e[3].requestSubmit())&&e[3].requestSubmit().apply(this,arguments)});const Ce=e[7].default,M=Ye(Ce,e,e[6],null);return{c(){a=L(),t=c("div"),n=c("div"),s=c("nav"),r=c("form"),f=c("fieldset"),p=c("label"),p.textContent=o,y=L(),u=c("select"),i=c("option"),i.textContent=D,k=c("option"),k.textContent=S,Z=L(),I=c("table"),g=c("thead"),B=c("tr"),H=c("th"),H.textContent=ie,G=L(),F=c("th"),F.textContent=ae,ne=L(),A=c("th"),J.c(),se=L();for(let h=0;h<v.length;h+=1)v[h].c();V=L(),O=c("nav"),K=c("label"),K.textContent=ye,E=L(),ce(R.$$.fragment),j=W(`
      of `),$=W(w),x=L(),M&&M.c(),this.h()},l(h){Ze("svelte-16df4tm",document.head).forEach(d),a=N(h),t=_(h,"DIV",{class:!0});var U=b(t);n=_(U,"DIV",{class:!0});var C=b(n);s=_(C,"NAV",{class:!0});var ve=b(s);r=_(ve,"FORM",{id:!0,class:!0});var Be=b(r);f=_(Be,"FIELDSET",{class:!0});var Ee=b(f);p=_(Ee,"LABEL",{for:!0,"data-svelte-h":!0}),oe(p)!=="svelte-iw296f"&&(p.textContent=o),y=N(Ee),u=_(Ee,"SELECT",{name:!0,id:!0});var we=b(u);i=_(we,"OPTION",{"data-svelte-h":!0}),oe(i)!=="svelte-1nu502o"&&(i.textContent=D),k=_(we,"OPTION",{"data-svelte-h":!0}),oe(k)!=="svelte-105yz3n"&&(k.textContent=S),we.forEach(d),Ee.forEach(d),Be.forEach(d),ve.forEach(d),Z=N(C),I=_(C,"TABLE",{class:!0});var $e=b(I);g=_($e,"THEAD",{class:!0});var Oe=b(g);B=_(Oe,"TR",{});var ue=b(B);H=_(ue,"TH",{class:!0,"data-svelte-h":!0}),oe(H)!=="svelte-17wqap5"&&(H.textContent=ie),G=N(ue),F=_(ue,"TH",{class:!0,"data-svelte-h":!0}),oe(F)!=="svelte-wgplya"&&(F.textContent=ae),ne=N(ue),A=_(ue,"TH",{class:!0});var Pe=b(A);J.l(Pe),Pe.forEach(d),ue.forEach(d),Oe.forEach(d),se=N($e);for(let Te=0;Te<v.length;Te+=1)v[Te].l($e);$e.forEach(d),V=N(C),O=_(C,"NAV",{class:!0});var de=b(O);K=_(de,"LABEL",{for:!0,"data-svelte-h":!0}),oe(K)!=="svelte-1r8oyu6"&&(K.textContent=ye),E=N(de),_e(R.$$.fragment,de),j=X(de,`
      of `),$=X(de,w),de.forEach(d),C.forEach(d),x=N(U),M&&M.l(U),U.forEach(d),this.h()},h(){document.title="Background Jobs | platformOS",m(p,"for","filter-type"),i.__value="SCHEDULED",Re(i,i.__value),k.__value="DEAD",Re(k,k.__value),m(u,"name","type"),m(u,"id","filter-type"),e[0].type===void 0&&xe(()=>e[8].call(u)),m(f,"class","svelte-1m1ug4d"),m(r,"id","filters"),m(r,"class","svelte-1m1ug4d"),m(s,"class","filters svelte-1m1ug4d"),m(H,"class","id svelte-1m1ug4d"),m(F,"class","svelte-1m1ug4d"),m(A,"class","svelte-1m1ug4d"),m(g,"class","svelte-1m1ug4d"),m(I,"class","svelte-1m1ug4d"),m(K,"for","page"),m(O,"class","pagination svelte-1m1ug4d"),m(n,"class","svelte-1m1ug4d"),m(t,"class","container svelte-1m1ug4d")},m(h,T){Y(h,a,T),Y(h,t,T),l(t,n),l(n,s),l(s,r),l(r,f),l(f,p),l(f,y),l(f,u),l(u,i),l(u,k),Me(u,e[0].type,!0),e[9](r),l(n,Z),l(n,I),l(I,g),l(g,B),l(B,H),l(B,G),l(B,F),l(B,ne),l(B,A),J.m(A,null),l(I,se);for(let U=0;U<v.length;U+=1)v[U]&&v[U].m(I,null);l(n,V),l(n,O),l(O,K),l(O,E),me(R,O,null),l(O,j),l(O,$),l(t,x),M&&M.m(t,null),P=!0,te||(ge=[fe(u,"change",e[8]),fe(u,"change",function(){Fe(e[3].requestSubmit())&&e[3].requestSubmit().apply(this,arguments)})],te=!0)},p(h,[T]){if(e=h,T&1&&Me(u,e[0].type),re!==(re=le(e))&&(J.d(1),J=re(e),J&&(J.c(),J.m(A,null))),T&55){Q=qe(e[1].results);let C;for(C=0;C<Q.length;C+=1){const ve=He(e,Q,C);v[C]?(v[C].p(ve,T),q(v[C],1)):(v[C]=Je(ve),v[C].c(),q(v[C],1),v[C].m(I,null))}for(Qe(),C=Q.length;C<v.length;C+=1)We(C);Ke()}const U={};T&2&&(U.max=e[1].total_pages),!ee&&T&1&&(ee=!0,U.value=e[0].page,et(()=>ee=!1)),R.$set(U),(!P||T&2)&&w!==(w=(e[1].total_pages||1)+"")&&be($,w),M&&M.p&&(!P||T&64)&&tt(M,Ce,e,e[6],P?nt(Ce,e[6],T,null):at(e[6]),null)},i(h){if(!P){for(let T=0;T<Q.length;T+=1)q(v[T]);q(R.$$.fragment,h),q(M,h),P=!0}},o(h){v=v.filter(Boolean);for(let T=0;T<v.length;T+=1)z(v[T]);z(R.$$.fragment,h),z(M,h),P=!1},d(h){h&&(d(a),d(t)),e[9](null),J.d(),st(v,h),he(R),M&&M.d(h),te=!1,Ge(ge)}}}function $t(e,a,t){let n;lt(e,ut,g=>t(4,n=g));let{$$slots:s={},$$scope:r}=a,f={results:[]},p={id:null},o={page:1,type:"SCHEDULED",...Object.fromEntries(n.url.searchParams)},y,u;const i=async()=>{clearInterval(u),t(1,f=await Se.get(o)),console.log(f),u=setInterval(()=>{f.results.forEach(g=>{o.type==="DEAD"?g.dead_at_parsed=pe(new Date(g.dead_at)):g.run_at_parsed=pe(new Date(g.run_at))})},1e3)};rt(()=>{clearInterval(u)});function D(){o.type=ot(this),t(0,o)}function k(g){ke[g?"unshift":"push"](()=>{y=g,t(3,y)})}const S=g=>t(2,p.id=g.id,p),Z=()=>t(2,p.id=null,p);function I(g){e.$$.not_equal(o.page,g)&&(o.page=g,t(0,o))}return e.$$set=g=>{"$$scope"in g&&t(6,r=g.$$scope)},e.$$.update=()=>{e.$$.dirty&1&&o&&i()},[o,f,p,y,n,i,r,s,D,k,S,Z,I]}class At extends Le{constructor(a){super(),Ne(this,a,$t,Et,Ie,{})}}export{At as component};
